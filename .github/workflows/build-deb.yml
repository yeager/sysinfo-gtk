name: Build .deb
on:
  push:
    tags: ['v*']
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build .deb
        run: |
          set -e
          NAME="sysinfo-gtk"
          MODULE="sysinfo_gtk"
          VER=$(grep -oP 'version = "\K[^"]+' pyproject.toml | head -1)
          BUILD="build/${NAME}_${VER}_all"
          mkdir -p "$BUILD/DEBIAN" "$BUILD/usr/bin" "$BUILD/usr/lib/python3/dist-packages/$MODULE" "$BUILD/usr/share/applications"
          printf 'Package: %s\nVersion: %s\nArchitecture: all\nMaintainer: Daniel Nylander <daniel@danielnylander.se>\nDepends: python3, python3-gi, gir1.2-gtk-4.0, gir1.2-adw-1\nSection: admin\nPriority: optional\nDescription: GTK4 system information and benchmark tool\n' "$NAME" "$VER" > "$BUILD/DEBIAN/control"
          cp src/$MODULE/*.py "$BUILD/usr/lib/python3/dist-packages/$MODULE/"
          printf '#!/usr/bin/env python3\nfrom %s.main import main\nmain()\n' "$MODULE" > "$BUILD/usr/bin/$NAME"
          chmod +x "$BUILD/usr/bin/$NAME"
          cp "$NAME.desktop" "$BUILD/usr/share/applications/"
          dpkg-deb --root-owner-group --build "$BUILD" "build/${NAME}_${VER}_all.deb"
      - uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: build/*.deb
